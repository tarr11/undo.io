<% content_for :javascript_includes do %>
  <%= javascript_include_tag "edit_file"  %>
    <%= javascript_include_tag "twitter/bootstrap/bootstrap-modal"  %>
  <%= javascript_include_tag "undo_mode" %>
<% end %>
<% content_for :stylesheet_includes do %>
  <%= stylesheet_link_tag "task_folder"  %>
<% end %>
<script type="text/javascript ">
function convertToSlug(Text)
{
    return Text
        .toLowerCase()
        .replace(/[^\w ]+/g,'')
        .replace(/ +/g,'-')
        ;
}

</script>
<style>

        .CodeMirror-scroll
        {

             height: auto; overflow: visible;
            min-height: 300px;
        }
        span.cm-undo-task
        {
            color: green;
            text-decoration: underline;
            cursor: pointer;
            cursor: hand;

        }
        span.cm-undo-people
        {
            color: #8b4513;
            text-decoration: underline;
            cursor: pointer;
            cursor: hand;
        }
        span.cm-undo-link
        {
            color:blue;
            text-decoration: underline;
            cursor: pointer;
            cursor: hand;

        }
        span.cm-undo-tag
        {
            color:purple;
            text-decoration: underline;
            cursor: pointer;
            cursor: hand;
        }

    .fullscreen {
        display: block;
        position: absolute;
        background-color: white;
        top: 40px;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        margin: 0;
        padding: 0;
        border: 0px solid #BBBBBB;
        opacity: 1;
    }

</style>
<script>
   function toggleFullscreenEditing()
    {
        var editorDiv = $('#read-only-contents');
        if (!editorDiv.hasClass('fullscreen')) {
            toggleFullscreenEditing.beforeFullscreen = { height: editorDiv.height(), width: editorDiv.width() }
            editorDiv.addClass('fullscreen');
            editorDiv.height('100%');
            editorDiv.width('100%');
            editor.refresh();
        }
        else {
            editorDiv.removeClass('fullscreen');
            editorDiv.height(toggleFullscreenEditing.beforeFullscreen.height);
            editorDiv.width(toggleFullscreenEditing.beforeFullscreen.width);
            editor.refresh();
        }
    }

</script>
<%= render 'layouts/breadcrumb'%>

<% if !@is_new_file %>
<div style="position: relative;">

     <div id="delete-modal" class="modal hide fade">
    <div class="modal-header">
      <a href="#" class="close">&times;</a>
      <h3>Delete <%=@file.shortName%>?</h3>
    </div>
    <div class="modal-body">
        <div class="clearfix">
        <div>Are you sure you want to delete <%=@file.filename%>?</div>
        </div>
    </div>
    <div class="modal-footer">
      <%= link_to 'Delete', @file, method: :delete, :class => "btn danger"%>
      <a href="#" id="cancel-delete-file" class="btn secondary cancel">Cancel</a>
    </div>
  </div>
  <div id="move-modal" class="modal hide fade">
    <%=form_tag(url_for(:action=>"move", :path=>params[:path]), :method=>"move", :id=>"move-form") do %>
    <div class="modal-header">
      <a href="#" class="close">&times;</a>
      <h3>Move <%=@file.shortName%></h3>
    </div>
    <div class="modal-body">
        <div class="clearfix">
        <div>Enter a new filename and path</div>
        <div><input type="text" name="filename" class="span8" value="<%=@file.filename%>"></div>
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn primary">Move</button>
      <a href="#" id="cancel-move-file" class="btn secondary cancel">Cancel</a>
    </div>
     <% end %>
  </div>
</div>
<% else %>
    <div id="save-modal" class="modal hide fade">
      <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3>Save New File</h3>
      </div>
      <div class="modal-body">
          <div class="clearfix">
          <div>Filename</div>
          <div class="input">
                <input id="filename" class="xlarge">
          </div>
          </div>

      </div>
      <div class="modal-footer">
        <a href="#" id="confirm-save-file" class="btn primary">Save</a>
        <a href="#" id="cancel-save-file" class="btn secondary">Cancel</a>
      </div>
    </div>

<% end%>
<style>

</style>

<% content_for :buttons do %>
<% end %>

<div class="row">
<div class="span8">
<div class="row">
  <div class="span4">
  <h3><%=@header%>
    <% if @file.is_public %>
        <span class="label label-success">Public</span>

    <% else %>
        <span class="label">Private</span>
    <% end %>
</h3>

  </div>
  <div class="span4">
    <% if @is_new_file
        new_button_style = ""
        edit_button_style = "display:none"
    else
        new_button_style = "display:none"
        edit_button_style = ""
    end %>
         <div class="pull-right" style="<%=edit_button_style%>">
           <div class="btn-group">
            <a href="#" id="edit-button" class="btn">Save</a>
             <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                <span class="caret"></span>
              </a>
           <ul class="dropdown-menu" style="text-align: left;">
            <li><%= link_to "New", {:controller => "task_folder", :action=>"new_file", :path=>params[:path]}%></li>
            <li><a href="#" id="move-button">Move</a></li>
            <li><a href="#" id="copy-button" >Copy</a></li>
            <li><a href="#" id="delete-button">Delete</a></li>
           <% if @file.is_public %>
            <li><a href="#" id="publish-button">Prv</a></li>
           <% else %>
            <li><a href="#" id="publish-button">Publish</a></li>
           <% end %>
       </ul>
           </div>
         </div>
        <div class="new-mode-buttons"  style="<%=new_button_style%>">
        <a href="#" id="save-new" class="btn primary">Save</a>
        </div>
  </div>
</div>
  <div id="status" style="display:none">&nbsp;</div>

    <div id="loading" style="display:none">Saving...</div>
    <div id="read-only-contents" style="font-family: courier new;width:100%;border: solid black 1px">
      <textarea id="editor"><%=@file.contents%></textarea>
      </div>

<% if !@file.contents.nil? %>
    <div>Last updated <%=time_ago_in_words(@file.revision_at)%> ago</div>
<% end %>
    <%= form_for(@file, :remote => true) do |f| %>
    <%= f.hidden_field :contents%>
    <%= f.hidden_field 'filename'%>
    <%= hidden_field_tag 'current-path', params[:path] %>
<% end %>
  </div>

<div class="span4">
  <% unless @is_new_file%>
  <h3>Feed</h3>
      <ul style="margin-left:0">
  <% @people.each do |person|%>
      <li class="undo-divider"><%=link_to person.name, :controller => "task_folder", :action => "person_view", :path=>@file.path , :person=>person.name%> </li>
      <%person.files.each do |file|%>
        <li class="undo-ul-li-heading">
          <%=link_to file.file.shortName, :controller => "task_folder", :action => "folder_view", :path=>file.file.filename %></li>
          <%file.file.to_enum(:get_lines).first(3).each do |line|%>
                <li class="undo-ul-li-desc"><%=line%></li>
          <% end%>
      <% end %>

  <% end %>

  <%@related_tags.each do |tag|%>
      <li class="undo-divider"><%=link_to "#" + tag.name, :controller => "task_folder", :action => "topic_view", :path=>@file.path , :topic=>tag.name%></li>
      <%tag.files.each do |file|%>
        <li class="undo-ul-li-heading"><%=link_to file.file.shortName, :controller => "task_folder", :action => "folder_view", :path=>file.file.filename %></li>
        <%file.file.to_enum(:get_lines).first(3).each do |line|%>
              <li class="undo-ul-li-desc"><%=line%></li>
        <% end%>
      <% end %>
  <% end %>
   </ul>
  <% end %>
</div>
</div>

